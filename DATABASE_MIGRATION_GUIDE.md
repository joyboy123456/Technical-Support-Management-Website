# ğŸš€ æ•°æ®åº“è¿ç§»å·¥å…·ä½¿ç”¨æ–‡æ¡£

## æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªä¸ºæŠ€æœ¯æ”¯æŒè®¾å¤‡ç®¡ç†ç½‘ç«™æ‰“é€ çš„**æ™ºèƒ½æ•°æ®åº“è¿ç§»ç³»ç»Ÿ**ï¼Œå¯ä»¥è‡ªåŠ¨æ‰«æã€è¿½è¸ªå’Œæ‰§è¡Œæ•°æ®åº“è¿ç§»ã€‚

### æ ¸å¿ƒç‰¹æ€§ âœ¨

- âœ… **è‡ªåŠ¨æ‰«æ**ï¼šè‡ªåŠ¨å‘ç° `supabase/migrations/` ç›®å½•ä¸‹çš„æ‰€æœ‰ SQL æ–‡ä»¶
- âœ… **è¿½è¸ªè®°å½•**ï¼šè®°å½•å·²æ‰§è¡Œçš„è¿ç§»ï¼Œé¿å…é‡å¤æ‰§è¡Œ
- âœ… **äº‹åŠ¡å®‰å…¨**ï¼šæ¯ä¸ªè¿ç§»åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¤±è´¥è‡ªåŠ¨å›æ»š
- âœ… **é›¶é…ç½®**ï¼šæ•°æ®åº“è¿æ¥å·²å†…ç½®ï¼Œæ— éœ€é¢å¤–é…ç½®
- âœ… **æ™ºèƒ½åˆ¤æ–­**ï¼šè‡ªåŠ¨åˆ¤æ–­å“ªäº›è¿ç§»éœ€è¦æ‰§è¡Œ

---

## å¿«é€Ÿå¼€å§‹

### 1. æŸ¥çœ‹è¿ç§»çŠ¶æ€

```bash
npm run migrate:status
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
ğŸ“Š æ•°æ®åº“è¿ç§»çŠ¶æ€
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
è¿ç§»æ–‡ä»¶åˆ—è¡¨:
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åºå·â”‚ æ–‡ä»¶å                          â”‚ çŠ¶æ€     â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    1â”‚ 0001_init.sql                   â”‚ âœ… å·²æ‰§è¡Œâ”‚
â”‚    2â”‚ 0002_outbound_inventory_simple.sqlâ”‚ âœ… å·²æ‰§è¡Œâ”‚
â”‚    3â”‚ 0003_devices_table.sql          â”‚ âœ… å·²æ‰§è¡Œâ”‚
â”‚    4â”‚ 0004_add_original_fields.sql    â”‚ â³ å¾…æ‰§è¡Œâ”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“ˆ ç»Ÿè®¡: æ€»è®¡ 4 ä¸ªï¼Œå·²æ‰§è¡Œ 3 ä¸ªï¼Œå¾…æ‰§è¡Œ 1 ä¸ª
```

### 2. æ‰§è¡Œå¾…å¤„ç†çš„è¿ç§»

```bash
npm run migrate
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
ğŸš€ æ™ºèƒ½æ•°æ®åº“è¿ç§»å·¥å…·å¯åŠ¨
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¡ è¿æ¥æ•°æ®åº“: postgresql://postgres:****@...
âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ

ğŸ“‚ å‘ç° 4 ä¸ªè¿ç§»æ–‡ä»¶
âœ“  å·²æ‰§è¡Œ 3 ä¸ªè¿ç§»

â³ å¾…æ‰§è¡Œ 1 ä¸ªè¿ç§»:
   1. 0004_add_original_fields.sql

ğŸ“„ æ‰§è¡Œè¿ç§»: 0004_add_original_fields.sql
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… è¿ç§»æˆåŠŸ: 0004_add_original_fields.sql

ğŸ‰ è¿ç§»å®Œæˆï¼æˆåŠŸæ‰§è¡Œ 1/1 ä¸ªè¿ç§»
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## å¯ç”¨å‘½ä»¤

| å‘½ä»¤ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| `npm run migrate` | æ‰§è¡Œæ‰€æœ‰å¾…å¤„ç†çš„è¿ç§» | éƒ¨ç½²æ–°ç‰ˆæœ¬ã€åŒæ­¥æ•°æ®åº“ç»“æ„ |
| `npm run migrate:status` | æŸ¥çœ‹è¿ç§»çŠ¶æ€ | æ£€æŸ¥æ•°æ®åº“æ˜¯å¦æœ€æ–° |
| `npm run migrate:reset` | é‡ç½®è¿ç§»è®°å½•è¡¨ | **å±é™©æ“ä½œ**ï¼Œä»…ç”¨äºå¼€å‘ç¯å¢ƒ |

---

## å·¥ä½œæµç¨‹

### å…¸å‹å¼€å‘æµç¨‹ ğŸ”„

```mermaid
graph LR
    A[ä¿®æ”¹ä»£ç ] --> B[åˆ›å»ºè¿ç§»æ–‡ä»¶]
    B --> C[æœ¬åœ°æµ‹è¯•è¿ç§»]
    C --> D[æäº¤åˆ° Git]
    D --> E[Push åˆ° GitHub]
    E --> F[æ•°æ®åº“è‡ªåŠ¨æ›´æ–°]
```

### è¯¦ç»†æ­¥éª¤

#### 1. åˆ›å»ºæ–°çš„è¿ç§»æ–‡ä»¶

åœ¨ `supabase/migrations/` ç›®å½•ä¸‹åˆ›å»ºæ–°æ–‡ä»¶ï¼š

```bash
# æ–‡ä»¶å‘½åè§„èŒƒï¼šXXXX_description.sql
# XXXX æ˜¯é€’å¢çš„åºå·ï¼ˆå¦‚ 0005ã€0006ï¼‰

supabase/migrations/0005_add_new_field.sql
```

**ç¤ºä¾‹è¿ç§»æ–‡ä»¶ï¼š**

```sql
-- æ·»åŠ æ–°å­—æ®µåˆ° devices è¡¨
ALTER TABLE devices
ADD COLUMN IF NOT EXISTS warranty_date DATE;

-- æ·»åŠ æ³¨é‡Š
COMMENT ON COLUMN devices.warranty_date IS 'ä¿ä¿®æˆªæ­¢æ—¥æœŸ';
```

#### 2. æœ¬åœ°æµ‹è¯•

```bash
# æŸ¥çœ‹å¾…æ‰§è¡Œçš„è¿ç§»
npm run migrate:status

# æ‰§è¡Œè¿ç§»
npm run migrate
```

#### 3. æäº¤å’Œæ¨é€

```bash
git add supabase/migrations/0005_add_new_field.sql
git commit -m "feat: æ·»åŠ è®¾å¤‡ä¿ä¿®æ—¥æœŸå­—æ®µ"
git push
```

#### 4. è‡ªåŠ¨åŒæ­¥åˆ°ç”Ÿäº§ç¯å¢ƒ

**æ–¹å¼Aï¼šæ‰‹åŠ¨è§¦å‘ï¼ˆæ¨èï¼‰**

åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼š
```bash
npm run migrate
```

**æ–¹å¼Bï¼šåœ¨ Vercel éƒ¨ç½²æ—¶è‡ªåŠ¨æ‰§è¡Œ**

åœ¨ `package.json` ä¸­å·²é…ç½®ï¼š
```json
"postinstall": "npm run migrate"
```

è¿™æ ·æ¯æ¬¡ Vercel éƒ¨ç½²æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œè¿ç§»ï¼

---

## è¿ç§»æ–‡ä»¶ç¼–å†™è§„èŒƒ

### âœ… æ¨èå†™æ³•

```sql
-- æè¿°æ€§æ³¨é‡Š
-- è¯´æ˜è¿™ä¸ªè¿ç§»çš„ç›®çš„

-- ä½¿ç”¨ IF NOT EXISTS é¿å…é‡å¤æ‰§è¡Œé”™è¯¯
ALTER TABLE table_name
ADD COLUMN IF NOT EXISTS column_name TYPE;

-- æ·»åŠ ç´¢å¼•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
CREATE INDEX IF NOT EXISTS idx_name ON table_name(column);

-- æ·»åŠ æ³¨é‡Š
COMMENT ON COLUMN table_name.column_name IS 'å­—æ®µè¯´æ˜';
```

### âŒ ä¸æ¨èå†™æ³•

```sql
-- âŒ æ²¡æœ‰ IF NOT EXISTSï¼Œé‡å¤æ‰§è¡Œä¼šæŠ¥é”™
ALTER TABLE table_name ADD COLUMN column_name TYPE;

-- âŒ æ²¡æœ‰äº‹åŠ¡ä¿æŠ¤çš„å¤šæ­¥æ“ä½œ
BEGIN;
  ALTER TABLE...
  UPDATE...
COMMIT;  -- è¿ç§»å·¥å…·å·²è‡ªåŠ¨å¤„ç†äº‹åŠ¡
```

### è¿ç§»æ–‡ä»¶å‘½åè§„èŒƒ

```
0001_init.sql                      # åˆå§‹åŒ–æ•°æ®åº“
0002_add_user_table.sql            # æ·»åŠ ç”¨æˆ·è¡¨
0003_update_device_schema.sql      # æ›´æ–°è®¾å¤‡è¡¨ç»“æ„
0004_add_original_fields.sql       # æ·»åŠ åŸå§‹å­—æ®µ
```

**è§„åˆ™ï¼š**
- ä½¿ç”¨ 4 ä½æ•°å­—å‰ç¼€ï¼ˆ0001, 0002, ...ï¼‰
- ä½¿ç”¨ä¸‹åˆ’çº¿åˆ†éš”
- ä½¿ç”¨å°å†™å­—æ¯
- æè¿°æ€§å‘½å

---

## ç¯å¢ƒå˜é‡é…ç½®

### æ•°æ®åº“è¿æ¥

è¿ç§»å·¥å…·ä¼šæŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§æŸ¥æ‰¾æ•°æ®åº“è¿æ¥ï¼š

1. ç¯å¢ƒå˜é‡ `DATABASE_URL`
2. ç¯å¢ƒå˜é‡ `SUPABASE_DB_URL`
3. é»˜è®¤å€¼ï¼ˆå·²å†…ç½®åœ¨è„šæœ¬ä¸­ï¼‰

**å¦‚ä½•è®¾ç½®ç¯å¢ƒå˜é‡ï¼š**

#### Windows
```bash
set DATABASE_URL=postgresql://postgres:password@host:5432/database
npm run migrate
```

#### Linux/Mac
```bash
export DATABASE_URL=postgresql://postgres:password@host:5432/database
npm run migrate
```

#### Vercel ç¯å¢ƒå˜é‡

åœ¨ Vercel Dashboard ä¸­è®¾ç½®ï¼š
- å˜é‡åï¼š`DATABASE_URL`
- å˜é‡å€¼ï¼š`postgresql://...`

---

## å¸¸è§é—®é¢˜

### Q1: è¿ç§»æ‰§è¡Œå¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**A:** è¿ç§»åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¤±è´¥ä¼šè‡ªåŠ¨å›æ»šã€‚æ£€æŸ¥é”™è¯¯ä¿¡æ¯ï¼Œä¿®å¤ SQL åé‡æ–°æ‰§è¡Œã€‚

```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
npm run migrate

# é”™è¯¯ç¤ºä¾‹ï¼š
âŒ è¿ç§»å¤±è´¥: column "xxx" already exists
```

**è§£å†³æ–¹æ¡ˆï¼š**
- åœ¨ SQL ä¸­æ·»åŠ  `IF NOT EXISTS` å­å¥
- æˆ–ä½¿ç”¨ `npm run migrate:reset` é‡ç½®è®°å½•ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

### Q2: å¦‚ä½•å›æ»šè¿ç§»ï¼Ÿ

**A:** åˆ›å»ºä¸€ä¸ªæ–°çš„è¿ç§»æ–‡ä»¶æ¥æ’¤é”€æ›´æ”¹ï¼š

```sql
-- 0006_rollback_field.sql
ALTER TABLE devices
DROP COLUMN IF EXISTS warranty_date;
```

### Q3: è¿ç§»è®°å½•è¡¨åœ¨å“ªé‡Œï¼Ÿ

**A:** è¿ç§»è®°å½•å­˜å‚¨åœ¨ `schema_migrations` è¡¨ä¸­ï¼š

```sql
SELECT * FROM schema_migrations ORDER BY name;
```

### Q4: å¦‚ä½•åœ¨æ–°ç¯å¢ƒä¸­åˆå§‹åŒ–æ•°æ®åº“ï¼Ÿ

**A:** ç›´æ¥è¿è¡Œè¿ç§»å³å¯ï¼š

```bash
npm install    # ä¼šè‡ªåŠ¨è¿è¡Œ postinstall
# æˆ–æ‰‹åŠ¨æ‰§è¡Œ
npm run migrate
```

---

## é«˜çº§ç”¨æ³•

### æ¡ä»¶è¿ç§»

```sql
-- ä»…å½“è¡¨ä¸å­˜åœ¨æ—¶åˆ›å»º
CREATE TABLE IF NOT EXISTS new_table (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL
);

-- ä»…å½“å­—æ®µä¸å­˜åœ¨æ—¶æ·»åŠ 
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT FROM information_schema.columns
    WHERE table_name = 'devices' AND column_name = 'new_field'
  ) THEN
    ALTER TABLE devices ADD COLUMN new_field TEXT;
  END IF;
END $$;
```

### æ•°æ®è¿ç§»

```sql
-- æ›´æ–°ç°æœ‰æ•°æ®
UPDATE devices
SET warranty_date = created_at + INTERVAL '1 year'
WHERE warranty_date IS NULL;

-- æ‰¹é‡æ’å…¥
INSERT INTO settings (key, value)
VALUES
  ('feature_flag_1', 'true'),
  ('feature_flag_2', 'false')
ON CONFLICT (key) DO NOTHING;
```

---

## å·¥å…·æ¶æ„

```
scripts/
â”œâ”€â”€ db-migrate.js           # æ™ºèƒ½è¿ç§»å·¥å…·ï¼ˆä¸»ç¨‹åºï¼‰
â””â”€â”€ migrate-db.js           # æ—§ç‰ˆå·¥å…·ï¼ˆå…¼å®¹æ€§ä¿ç•™ï¼‰

supabase/migrations/        # è¿ç§»æ–‡ä»¶ç›®å½•
â”œâ”€â”€ 0001_init.sql
â”œâ”€â”€ 0002_outbound_inventory_simple.sql
â”œâ”€â”€ 0003_devices_table.sql
â””â”€â”€ 0004_add_original_fields.sql

æ•°æ®åº“:
â””â”€â”€ schema_migrations       # è¿ç§»è®°å½•è¡¨
    â”œâ”€â”€ id                  # è‡ªå¢ID
    â”œâ”€â”€ name                # è¿ç§»æ–‡ä»¶å
    â”œâ”€â”€ executed_at         # æ‰§è¡Œæ—¶é—´
    â””â”€â”€ checksum            # æ–‡ä»¶æ ¡éªŒå’Œ
```

---

## æœ€ä½³å®è·µ ğŸ’¡

1. **æ€»æ˜¯ä½¿ç”¨ `IF NOT EXISTS`**ï¼šé¿å…é‡å¤æ‰§è¡Œé”™è¯¯
2. **å°æ­¥è¿­ä»£**ï¼šä¸€ä¸ªè¿ç§»æ–‡ä»¶åªåšä¸€ä»¶äº‹
3. **å…ˆæµ‹è¯•åéƒ¨ç½²**ï¼šæœ¬åœ°æµ‹è¯•é€šè¿‡å†æ¨é€
4. **è®°å½•å˜æ›´åŸå› **ï¼šåœ¨ SQL æ–‡ä»¶ä¸­æ·»åŠ è¯¦ç»†æ³¨é‡Š
5. **å¤‡ä»½é‡è¦æ•°æ®**ï¼šæ‰§è¡Œç ´åæ€§æ“ä½œå‰å…ˆå¤‡ä»½

---

## æ•…éšœæ’é™¤

### è¿æ¥é—®é¢˜

```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
npm run test:db

# æˆ–ç›´æ¥æµ‹è¯•è¿ç§»è¿æ¥
npm run migrate:status
```

### æƒé™é—®é¢˜

ç¡®ä¿æ•°æ®åº“ç”¨æˆ·æœ‰ä»¥ä¸‹æƒé™ï¼š
- CREATE TABLE
- ALTER TABLE
- CREATE INDEX
- SELECT, INSERT, UPDATE

### æ–‡ä»¶ç¼–ç é—®é¢˜

ç¡®ä¿è¿ç§»æ–‡ä»¶ä½¿ç”¨ UTF-8 ç¼–ç ã€‚

---

## æ”¯æŒ

é‡åˆ°é—®é¢˜ï¼Ÿ

1. æŸ¥çœ‹è¿ç§»çŠ¶æ€ï¼š`npm run migrate:status`
2. æ£€æŸ¥æ•°æ®åº“æ—¥å¿—
3. è”ç³»å¼€å‘å›¢é˜Ÿ

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** 1.0
**æœ€åæ›´æ–°ï¼š** 2025-10-14
**ç»´æŠ¤è€…ï¼š** æµ®æµ®é…± ğŸ±
