# 部署修复指南

## 问题诊断

### 原始问题
- 直接访问 `http://192.168.80.23:3001` 可以正常访问 API
- 通过 Nginx 代理访问 `https://support-management.wujieai.com` 提示"后端不可用"

### 根本原因
前端代码中的 API 调用方式：
```javascript
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001';
fetch(`${API_BASE_URL}${endpoint}`, ...)
```

当 `VITE_API_BASE_URL=https://support-management.wujieai.com/api` 时：
- 前端调用：`https://support-management.wujieai.com/api/query`
- Nginx 代理：`/api/query` → `http://127.0.0.1:3001/query`
- 但 API 服务期望的路径是 `/query`，不是 `/api/query`

## 解决方案

### 方案一：简化配置（推荐）
直接让前端调用 API 服务，不通过 Nginx 代理：

**修改 `.env.production`：**
```env
VITE_API_BASE_URL=http://192.168.80.23:3001
```

**优点：**
- 配置简单
- 减少代理层，性能更好
- 避免路径重写问题

### 方案二：使用 Nginx 代理
如果必须使用 Nginx 代理，使用提供的 `nginx-production.conf`：

**关键配置：**
```nginx
location /api/ {
    rewrite ^/api/(.*)$ /$1 break;
    proxy_pass http://127.0.0.1:3001;
    # ... 其他配置
}
```

**环境变量：**
```env
VITE_API_BASE_URL=https://support-management.wujieai.com/api
```

## 部署步骤

### 使用方案一（推荐）

1. **更新环境配置**（已完成）：
   ```bash
   # .env.production 已更新为：
   VITE_API_BASE_URL=http://192.168.80.23:3001
   ```

2. **重新构建前端镜像**：
   ```bash
   # 如果前端镜像包含了环境变量，需要重新构建
   docker build -f Dockerfile.frontend -t swr.cn-east-3.myhuaweicloud.com/btc8_public/tech-support-ui:v1 .
   ```

3. **部署服务**：
   ```bash
   docker-compose down
   docker-compose up -d
   ```

### 使用方案二（Nginx 代理）

1. **部署 Nginx 配置**：
   ```bash
   sudo cp nginx-production.conf /etc/nginx/conf.d/support-Management.conf
   sudo nginx -t
   sudo systemctl reload nginx
   ```

2. **更新环境变量**：
   ```env
   VITE_API_BASE_URL=https://support-management.wujieai.com/api
   ```

3. **重新部署服务**：
   ```bash
   docker-compose down
   docker-compose up -d
   ```

## 验证步骤

1. **检查服务状态**：
   ```bash
   docker-compose ps
   ```

2. **测试 API 连接**：
   ```bash
   # 方案一
   curl http://192.168.80.23:3001/health
   
   # 方案二
   curl https://support-management.wujieai.com/api/health
   ```

3. **检查前端访问**：
   - 访问：`https://support-management.wujieai.com`
   - 打开浏览器开发者工具 → Network 标签
   - 观察 API 请求是否成功

## 故障排除

### 如果仍然提示"后端不可用"

1. **检查 Docker 容器状态**：
   ```bash
   docker logs tech-support-api
   docker logs tech-support-ui
   ```

2. **检查端口占用**：
   ```bash
   netstat -tlnp | grep :3001
   netstat -tlnp | grep :3002
   ```

3. **检查防火墙**：
   ```bash
   # 确保端口 3001, 3002 可访问
   sudo ufw status
   ```

4. **检查数据库连接**：
   ```bash
   # 进入 API 容器检查数据库连接
   docker exec -it tech-support-api sh
   ```

### 常见错误

1. **CORS 错误**：前端和 API 不在同一域名下
2. **网络错误**：容器间网络配置问题
3. **环境变量**：前端镜像中的环境变量未正确设置

## 推荐配置

基于您的情况，推荐使用**方案一**：
- 前端通过 Nginx 提供 HTTPS 访问
- API 直接通过 HTTP 端口访问
- 简单、稳定、易维护

当前配置文件已按方案一进行了修改。